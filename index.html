<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>リンバス所持人格E.G.O共有ツール</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    h2 {
      font-size: 24px;
      margin-bottom: 20px;
    }

    .checklist-container {
     display: flex;
     flex-wrap: wrap;
    }

    .status {
      width: 90px;
      height: 90px;
      padding: 0;
      background-color: transparent;
      border: none;
      text-align: center;
      cursor: pointer;
      display: inline-block;
      box-sizing: border-box;
      margin: 0;
    }

    .status-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #shareImg {
      cursor: pointer;
      width: 150px;
      margin-top: 20px;
    }

    #shareUrl {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      height: 40px;
      overflow-x: auto;
      white-space: normal;
    }
  </style>
</head>
<body>

  <h2>リンバス所持人格E.G.O共有ツール</h2>
  <p>クリックして強化段階を変更できます。<br>実装順に並んでいます。</p>
  <p><button id="resetButton">全て未所持に</button></p>

  <div class="checklist-container" data-group="1"></div>
  <div class="checklist-container" data-group="2"></div>
  <div class="checklist-container" data-group="3"></div>
  <div class="checklist-container" data-group="4"></div>
  <div class="checklist-container" data-group="5"></div>

  <p>共有用URL: <input type="text" id="shareUrl" readonly></p>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const baseImageUrl = "https://raw.githubusercontent.com/394ast/limbus.checklist/main/";
    const defaultState = 4; // 初期状態
    const maxState = 4; // 状態の最大値
    const groupSettings = {
      1: { startId: 1001, count: 10 },
      2: { startId: 2001, count: 10 },
      3: { startId: 3001, count: 10 },
      4: { startId: 4001, count: 10 },
      5: { startId: 5001, count: 11 },
    };

    // 各コンテナに要素を生成
    document.querySelectorAll(".checklist-container").forEach(container => {
      const group = container.getAttribute("data-group");
      const { startId, count } = groupSettings[group];
  
      for (let i = startId; i < startId + count; i++) {
        const statusDiv = document.createElement("div");
        statusDiv.className = "status";
        statusDiv.setAttribute("data-id", i);
  
        const img = document.createElement("img");
        img.src = `${baseImageUrl}limbus${i}.${defaultState}.png`;
        img.alt = defaultState;
        img.className = "status-img";
  
        statusDiv.appendChild(img);
        container.appendChild(statusDiv);
      }
    });

    const shareUrl = document.getElementById("shareUrl");

   // 状態復元処理
    const urlParams = new URLSearchParams(window.location.search);
    const statesParam = urlParams.get("states");
    if (statesParam) {
      if (statesParam) {
        const { result: decompressedStates, groupCounts } = decompressData(statesParam); // 解凍処理
        restoreState(decompressedStates, groupCounts); 
      }
    }
  
    // クリック時の状態変更とURL更新
    document.querySelectorAll(".status").forEach(statusDiv => {
      statusDiv.addEventListener("click", () => {
        const img = statusDiv.querySelector(".status-img");
        const id = statusDiv.getAttribute("data-id");
        let currentState = parseInt(img.alt, 10);
        currentState = (currentState + 1) % (maxState + 1); // 状態を循環
        img.src = `${baseImageUrl}limbus${id}.${currentState}.png`;
        img.alt = currentState;
  
        // URLを更新
        updateUrl();
      });
    });
  
    // URL更新関数
    function updateUrl() {
      const states = Array.from(document.querySelectorAll(".status"))
        .map(div => {
          const state = div.querySelector(".status-img").alt;
          return state; // 状態だけをURLに追加
        });

      const compressedData = compressData(states);
      const baseUrl = "https://394ast.github.io/limbus.checklist/";
      shareUrl.value = `${baseUrl}?states=${compressedData}`;
    }
  
    // 圧縮関数（ランレングス圧縮）
    function runLengthEncode(data) {
      let result = '';
      let count = 1;
      for (let i = 1; i < data.length; i++) {
        if (data[i] === data[i - 1]) {
          count++;
        } else {
          result += (count < 10 ? '0' : '') + count + data[i - 1];
          count = 1;
        }
      }
      result += (count < 10 ? '0' : '') + count + data[data.length - 1];
      return result;
    }

    // 解凍関数（ランレングス圧縮の逆）
    function runLengthDecode(encodedData) {
      let result = [];
      let i = 0;
  
    while (i < encodedData.length) {
      let count = parseInt(encodedData[i] + encodedData[i + 1]); // 2桁に対応
      let state = encodedData[i + 2];
    
    for (let j = 0; j < count; j++) {
      result.push(state);
    }
    i += 3; // 次のペアへ
    }
  
    return result;
    }


    // 圧縮処理
    function compressData(states) {
      let result = [];
      let currentGroup = [];
      const separator = '-';  // 区切り文字

      let idx = 0;
      // 各グループごとに圧縮
      for (const [group, { count }] of Object.entries(groupSettings)) {
        // そのグループの状態を処理
        for (let i = 0; i < count; i++) {
          const state = states[idx++];
          currentGroup.push(state);

          // グループの最後で区切りを入れる
          if (currentGroup.length === count) {
            result.push(runLengthEncode(currentGroup)); // 現在のグループを圧縮
            if (Object.entries(groupSettings).length - 1 !== parseInt(group) - 1) {
              result.push(separator); // 最後のグループ以外に区切り文字を追加
            }
            currentGroup = []; // 次のグループを開始
          }
        }
      }
      return result.join("");
      }

    // 解凍処理
    function decompressData(encodedData) {
      let groups = encodedData.split('-'); // 圧縮時に使った区切り文字で分割
      let decompressedStates = [];
      let groupCounts = [];  // グループごとの要素数を保存する配列

      groups.forEach(group => {
      if (group) {
      // runLengthDecodeで状態の配列と要素数を取得
      const { result } = runLengthDecode(group);
      decompressedStates = decompressedStates.concat(result); // 状態を追加
      groupCounts.push(result.length); // ここで文字数（配列の長さ）をカウント
      }
     });
  
      return { result: decompressedStates, groupCounts }; // 状態とグループごとの要素数を返す
    }


    // 状態を復元する関数 
    function restoreState(states, groupCounts) {
      let idx = 0;

      // 各グループに対して状態を復元
      Object.entries(groupSettings).forEach(([group, { startId, count }], groupIndex) => {
      const groupStates = states.slice(idx, idx + groupCounts[groupIndex]); // グループ分の状態を取り出す
      idx += groupCounts[groupIndex]; // 次のグループの開始インデックスに進む

      // 実際の状態数と設定されたカウントを比較
      const groupCount = groupSettings[group].count;

      // 実際の状態数が設定されたカウントより少ない場合、0の状態を埋める
      if (groupCounts[groupIndex] < groupCount) {
      const missingStates = groupCount - groupCounts[groupIndex]; // 足りない状態数
      groupStates.push(...Array(missingStates).fill("0")); // 0で埋める
      }

      // 各IDに対して状態を適用
      for (let i = 0; i < groupCount; i++) {
        const id = startId + i;
        const state = groupStates[i]; // 現在の状態を取得
        const statusDiv = document.querySelector(`.status[data-id="${id}"]`);
      
      if (statusDiv) {
        const img = statusDiv.querySelector(".status-img");
        img.src = `${baseImageUrl}limbus${id}.${state}.png`;
        img.alt = state;
      }
      }
      });
      }


    // 全てリセットボタンの処理
    document.getElementById("resetButton").addEventListener("click", () => {
      document.querySelectorAll(".status").forEach(statusDiv => {
        const img = statusDiv.querySelector(".status-img");
        const id = statusDiv.getAttribute("data-id");
        img.src = `${baseImageUrl}limbus${id}.0.png`; // 状態を0に変更
        img.alt = 0;
      });
      updateUrl(); // URLも更新
    });
  });
  </script>

</body>
</html>
