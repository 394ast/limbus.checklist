<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>リンバス所持人格E.G.O共有ツール</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    h2 {
      font-size: 24px;
      margin-bottom: 20px;
    }

    .checklist-container {
      display: flex;
      flex-wrap: wrap;
    }

    .status {
      width: 90px;
      height: 90px;
      padding: 0;
      background-color: transparent;
      border: none;
      text-align: center;
      cursor: pointer;
      display: inline-block;
      box-sizing: border-box;
      margin: 0;
    }

    .status-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #shareImg {
      cursor: pointer;
      width: 150px;
      margin-top: 20px;
    }

    textarea {
      width: 100%; /* 親要素の幅に合わせる */
      padding: 10px; /* 余白を設定 */
      font-size: 16px; /* フォントサイズを指定 */
      resize: none; /* ユーザーによる手動のリサイズを無効にする */
      overflow: hidden; /* スクロールバーを表示しない */
      box-sizing: border-box; /* パディングとボーダーを含めたサイズ計算 */
    }
 
  </style>
</head>
<body>

  <h2>リンバス所持人格E.G.O共有ツール</h2>
  <p>画像をクリックして強化段階を変更できます。<br>人格は同期化段階に合わせて画像も変わります。<br>実装順に並んでいます。<br>一番下に共有用URLが表示されます。</p>
  <p><button id="resetButton">初期人格E.G.Oのみ所持</button></p>

  <div class="checklist-container" data-group="1"></div>
  <div class="checklist-container" data-group="2"></div>
  <div class="checklist-container" data-group="3"></div>
  <div class="checklist-container" data-group="4"></div>
  <div class="checklist-container" data-group="5"></div>
  <div class="checklist-container" data-group="6"></div>
  <div class="checklist-container" data-group="7"></div>
  <div class="checklist-container" data-group="8"></div>
  <div class="checklist-container" data-group="9"></div>
  <div class="checklist-container" data-group="10"></div>
  <div class="checklist-container" data-group="11"></div>
  <div class="checklist-container" data-group="12"></div>
  <div class="checklist-container" data-group="13"></div>
  <div class="checklist-container" data-group="14"></div>
  <div class="checklist-container" data-group="15"></div>
  <div class="checklist-container" data-group="16"></div>
  <div class="checklist-container" data-group="17"></div>
  <div class="checklist-container" data-group="18"></div>
  <div class="checklist-container" data-group="19"></div>
  <div class="checklist-container" data-group="20"></div>
  <div class="checklist-container" data-group="21"></div>
  <div class="checklist-container" data-group="22"></div>
  <div class="checklist-container" data-group="23"></div>
  <div class="checklist-container" data-group="24"></div>

  <p>共有用URL: <textarea id="shareUrl" readonly></textarea></p>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const baseImageUrl = "https://raw.githubusercontent.com/394ast/limbus.checklist/main/";
    const defaultState = 4; // 初期状態
    const maxState = 4; // 状態の最大値
    const groupSettings = {
      1: { startId: 1001, count: 10 },
      2: { startId: 2001, count: 10 },
      3: { startId: 3001, count: 10 },
      4: { startId: 4001, count: 10 },
      5: { startId: 5001, count: 11 },
      6: { startId: 6001, count: 10 },
      7: { startId: 7001, count: 10 },
      8: { startId: 8001, count: 10 },
      9: { startId: 9001, count: 11 },
      10: { startId: 10001, count: 11 },
      11: { startId: 11001, count: 11 },
      12: { startId: 12001, count: 10 },
      13: { startId: 13001, count: 7 },
      14: { startId: 14001, count: 8 },
      15: { startId: 15001, count: 8 },
      16: { startId: 16001, count: 7 },
      17: { startId: 17001, count: 7 },
      18: { startId: 18001, count: 7 },
      19: { startId: 19001, count: 8 },
      20: { startId: 20001, count: 7 },
      21: { startId: 21001, count: 7 },
      22: { startId: 22001, count: 7 },
      23: { startId: 23001, count: 7 },
      24: { startId: 24001, count: 7 },
    }; // 新規で追加するときはここを変更する

    // 各コンテナに要素を生成
    document.querySelectorAll(".checklist-container").forEach(container => {
      const group = container.getAttribute("data-group");
      const { startId, count } = groupSettings[group];

      for (let i = startId; i < startId + count; i++) {
        const statusDiv = document.createElement("div");
        statusDiv.className = "status";
        statusDiv.setAttribute("data-id", i);

        const img = document.createElement("img");
        img.src = `${baseImageUrl}limbus${i}.${defaultState}.png`;
        img.alt = defaultState;
        img.className = "status-img";

        statusDiv.appendChild(img);
        container.appendChild(statusDiv);
      }
    });

    const shareUrl = document.getElementById("shareUrl");

    // 状態復元処理
    const urlParams = new URLSearchParams(window.location.search);
    const statesParam = urlParams.get("states");
    if (statesParam) {
      const { result: decompressedStates } = decompressData(statesParam); // 解凍処理
      restoreState(decompressedStates);
    }

    // ページが読み込まれたときにもURLを更新
      updateUrl();

    // クリック時の状態変更とURL更新
    document.querySelectorAll(".status").forEach(statusDiv => {
      statusDiv.addEventListener("click", () => {
        const img = statusDiv.querySelector(".status-img");
        const id = statusDiv.getAttribute("data-id");
        let currentState = parseInt(img.alt, 10) || 0; // alt属性から現在の状態を取得
        currentState = (currentState + 1) % (maxState + 1); // 状態を循環
        img.src = `${baseImageUrl}limbus${id}.${currentState}.png`;
        img.alt = currentState; // 新しい状態をalt属性に設定

        updateUrl(); // URLを更新
      });
    });

    // URL更新関数
    function updateUrl() {
      const states = Array.from(document.querySelectorAll(".status"))
        .map(div => div.querySelector(".status-img").alt);

      const compressedData = compressData(states);
      const encodedData = btoa(compressedData); // Base64エンコード
      const baseUrl = "https://394ast.github.io/limbus.checklist/";
      shareUrl.value = `${baseUrl}?states=${encodedData}`;

      adjustTextareaHeight(); // テキストエリアの高さを更新
    }

    // 圧縮関数（ランレングス圧縮）
    function runLengthEncode(data) {
      let result = '';
      let count = 1;
      for (let i = 1; i < data.length; i++) {
        if (data[i] === data[i - 1]) {
          count++;
        } else {
          result += (count < 10 ? '0' : '') + count + data[i - 1]; // 2桁に変更
          count = 1;
        }
      }
      result += (count < 10 ? '0' : '') + count + data[data.length - 1];
      return result;
    }

    // 解凍関数（ランレングス圧縮の逆）
    function runLengthDecode(encodedData) {
      let result = [];
      let i = 0;
      while (i < encodedData.length) {
        let count = parseInt(encodedData[i] + encodedData[i + 1]); // 2桁に対応
        let state = encodedData[i + 2];
        for (let j = 0; j < count; j++) {
          result.push(state);
        }
        i += 3; // 次のペアへ
      }
      return result;
    }

    // 圧縮処理
    function compressData(states) {
      const separator = '-';
      const groupStates = Object.entries(groupSettings).map(([group, { count }], index) => {
        const start = Object.values(groupSettings).slice(0, index).reduce((sum, g) => sum + g.count, 0);
        return runLengthEncode(states.slice(start, start + count));
      });
      return groupStates.join(separator);
    }

    // 解凍処理
    function decompressData(encodedData) {
      const decodedData = atob(encodedData); // Base64デコード
      const groups = decodedData.split('-');
      const decompressedStates = [];

      groups.forEach((group, index) => {
        const { count } = Object.values(groupSettings)[index];
        if (group) {
          const decoded = runLengthDecode(group);
          while (decoded.length < count) {
            decoded.push("0"); // 不足分を補完
          }
          decompressedStates.push(...decoded);
        }
      });

      return { result: decompressedStates };
    }

    // 状態を復元する関数 
    function restoreState(states) {
      let idx = 0;

      Object.entries(groupSettings).forEach(([group, { startId, count }]) => {
        const groupStates = states.slice(idx, idx + count); // グループ分の状態を取り出す
        idx += count;

        for (let i = 0; i < count; i++) {
          const id = startId + i;
          const state = groupStates[i];
          const statusDiv = document.querySelector(`.status[data-id="${id}"]`);

          if (statusDiv) {
            const img = statusDiv.querySelector(".status-img");
            img.src = `${baseImageUrl}limbus${id}.${state}.png`;
            img.alt = state;
          }
        }
      });
    }

    // 全てリセットボタンの処理
    document.getElementById("resetButton").addEventListener("click", () => {
    document.querySelectorAll(".status").forEach(statusDiv => {
    const img = statusDiv.querySelector(".status-img");
    const id = parseInt(statusDiv.getAttribute("data-id"), 10); // 数値に変換

    if (id % 1000 === 1 && id >= 1001 && id <= 24001) {
      // IDが1001, 2001, ..., 24001の規則に一致する場合
      img.src = `${baseImageUrl}limbus${id}.1.png`;
      img.alt = 1;
    } else {
      // その他のIDは状態を0に変更
      img.src = `${baseImageUrl}limbus${id}.0.png`;
      img.alt = 0;
    }
    });
    updateUrl(); // URLも更新
    });
    
    function adjustTextareaHeight() {
    const textarea = document.getElementById('shareUrl');
    
    // 高さを自動的にリセット
    textarea.style.height = 'auto'; 
    
    // テキストエリアの内容に基づいて高さを調整
    textarea.style.height = textarea.scrollHeight + 'px';
    }

    // ページのリサイズ時にも調整
    window.addEventListener('resize', adjustTextareaHeight);

  });
  </script>

</body>
</html>
